name: Fork

on:
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  TZ: Asia/Shanghai

jobs:
  fork:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v6

      - name: è‡ªåŠ¨åŒæ­¥æ‰€æœ‰ Fork ä»“åº“
        run: |
          set -x
          OWNERS=(zzzzzzqqq8 dog-org)

          echo "### ğŸ”„ åŒæ­¥ä»»åŠ¡æ±‡æ€»" >>$GITHUB_STEP_SUMMARY
          echo "| ä»“åº“ | åˆ†æ”¯ | çŠ¶æ€ | è¯¦æƒ… |" >>$GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >>$GITHUB_STEP_SUMMARY

          SUCCESS_REPOS=()
          SKIPPED_REPOS=()
          FAILED_REPOS=()

          for user in ${OWNERS[@]}; do
            echo "ğŸ” æ­£åœ¨å¤„ç†ç”¨æˆ·ï¼š$user"

            case $user in
              zzzzzzqqq8) export GH_TOKEN=${{ secrets.ZZQ_TOKEN }} ;;
              dog-org) export GH_TOKEN=${{ secrets.DOG_TOKEN }} ;;
              *) continue ;;
            esac

            while read -r row; do
              [[ -z $row ]] && continue
              repo_name=${row%,*}
              branch=${row#*,}

              echo "ğŸš€ æ­£åœ¨åŒæ­¥ $repo_name [ $branch ]..."

              response=$(curl -sSL -o /tmp/resp.json -w "%{http_code}" \
                -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                https://api.github.com/repos/$repo_name/merge-upstream \
                -d "{\"branch\":\"$branch\"}")

              case $response in
                200|202)
                  status="âœ… æˆåŠŸ"
                  msg="åŒæ­¥æˆåŠŸ"
                  SUCCESS_REPOS+=($repo_name)
                  ;;
                409)
                  status="âš ï¸ è·³è¿‡"
                  msg="å·²æ˜¯æœ€æ–°"
                  SKIPPED_REPOS+=($repo_name)
                  ;;
                *)
                  status="âŒ å¤±è´¥"
                  msg="$(jq -r '.message' /tmp/resp.json 2>/dev/null || echo "HTTP $response")"
                  FAILED_REPOS+=("$repo_name ($msg)")
                  ;;
              esac

              echo "| $repo_name | $branch | $status | $msg |" >>$GITHUB_STEP_SUMMARY

            done < <(gh repo list $user --fork --limit 1000 --json nameWithOwner,defaultBranchRef --jq '.[] | "\(.nameWithOwner),\(.defaultBranchRef.name)"' | sort -f)
          done

          MSG=

          function add_msg_block() {
            local icon=$1
            local title=$2
            local -n arr=$3

            [[ ${#arr[@]} -eq 0 ]] && return

            MSG=${MSG}$'\n'<b>${icon} ${title} ( ${#arr[@]} ):</b>

            for repo in ${arr[@]}; do
              MSG=${MSG}$'\n'â€¢ <code>$repo</code>
            done
          }

          add_msg_block "âœ…" "æˆåŠŸ" SUCCESS_REPOS
          add_msg_block "âš ï¸" "è·³è¿‡" SKIPPED_REPOS
          add_msg_block "âŒ" "å¤±è´¥" FAILED_REPOS

          [[ -z $MSG ]] && MSG=$'\n'<b>âš ï¸ æœ¬æ¬¡æ— åŒæ­¥ä»»åŠ¡æ‰§è¡Œ</b>

          printf "TG_MSG<<EOF\n%b\nEOF\n" $MSG >>$GITHUB_ENV

      - name: å‘é€åŒæ­¥ç»“æœè‡³ Telegram
        uses: appleboy/telegram-action@v1.0.1
        if: always()
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          message: |
            <b>ğŸš€ Fork åŒæ­¥æŠ¥å‘Š</b>
            ${{ env.TG_MSG }}

            <b>ğŸ“¦ é¡¹ç›®ä¿¡æ¯</b>
            ä»“åº“ï¼š<code>${{ github.repository }}</code>
            åˆ†æ”¯ï¼š<code>${{ github.ref_name }}</code>
            ç¼–å·ï¼š<code>${{ github.run_number }}</code>

            <b>ğŸ‘¤ è§¦å‘ä¿¡æ¯</b>
            è´¦å·ï¼š<code>${{ github.actor }}</code>
            è§¦å‘ï¼š<code>${{ github.event_name }}</code>
            å“ˆå¸Œï¼š<code>${{ github.sha }}</code>

            <b>ğŸ”— å¿«é€Ÿé“¾æ¥</b>
            <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">ğŸ“‹ æŸ¥çœ‹å®Œæ•´æ—¥å¿—</a>
            <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">ğŸ’» æŸ¥çœ‹ä»£ç å˜æ›´</a>
